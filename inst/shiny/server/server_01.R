#
# This is the server logic of a Shiny web application. You can run the
# application by clicking 'Run App' above.
#
# Find out more about building applications with Shiny here:
#
#    http://shiny.rstudio.com/
#

library(SummarizedExperiment)
source("../../R/import.R")


### Ingest user data
observe({
    # Look for user file upload
    if (!is.null(input$counts) & !is.null(input$md)){
        se <<- ingest_data(input$counts$datapath, input$md$datapath)
    }
    else if (!is.null(input$se)){
        se <<- SummarizedExperiment(input$se$datapath)
    }
    else {
        se <<- NULL
    }
    # Populate drop down menu with covariates
    req(se)
    covs <- metadata(se)$covariates
    updateSelectInput(inputId = "covariate", choices = covs)
})

### Create batch design table when covariate selected
observeEvent(input$covariate, {
    req(se)
    output$summaryTable <- renderTable({
        bd <<- batch_design(se, input$covariate)
    })
})

# Compute counfounding design
observeEvent(input$covariate, {
    req(se)
    output$confoundingTable <- renderTable({
        metadata(se)$confound.metrics
    }, rownames = T)
})


# Create PCA Plot
observeEvent(input$correctionMethod, {
    req(se)

    # If no correction methods have been used yet, use the default value in the
    # selectInput to create a PCA plot with just "counts". Otherwise, use
    # updateSelectInput elsewhere (after correction method like ComBat) to add
    # to the list of options, and then use that to create the PCA
    value <- reactive({
        if (identical(input$correctionMethod, "None")) {
            input$correctionMethod <- "counts"
        }
        else
            input$correctionMethod
        })

    output$pcaPlot <- renderPlot({
        plot_pca(se)
    })
})
